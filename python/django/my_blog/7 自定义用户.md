1. 整合代码，用户相关操作归档到新app accounts
2. 自定义全局模板变量
```python
# accounts/context_processors.py
# 自定义全局模板变量

from .forms import LoginForm

def login_modal_form(request):
    """添加全局模板变量

    :param request: request
    :return: 登录表单实例化
    """
    return {'login_modal_form': LoginForm()}


# my_blog/settings.py
# 添加自定义全局模板变量

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                # 自定义全局模板变量
                'accounts.context_processors.login_modal_form',

            ],
        'libraries': {
            'comment_tags': 'comment.templatetags.comment_tags',
            'likes_tags': 'likes.templatetags.likes_tags',

            }

        },
    },
]

# 模板中可直接使用实例化的登录表单
{{ login_modal_form }}
```

3. 修改基础模板
```html
# templates/base.html
# 添加登录弹框以及相关js

{% load staticfiles %}
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>{% block title %}{% endblock title %}| OlesetCrab Blog</title>

    <!-- Bootstrap -->
    <link href="{% static 'base.css' %}" rel="stylesheet">
    <link href="{% static 'bootstrap-3.3.7/css/bootstrap.min.css' %}" rel="stylesheet">
    {% block header_extends %}

    {% endblock header_extends %}
    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
    <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="{% url 'home' %}">我的博客</a>
                <!-- 自适应窗口导航栏变成按钮 -->
                <button class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse"></button>
                <!-- <span class="sr-only">Toggle navigation</span> -->
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </div>
            <div id="navbar-collapse" class="collapse navbar-collapse">
                <!-- 导航栏左边 -->
                <ul class="nav navbar-nav">
                    <li class="{% block nav_home_active %}{% endblock %}">
                        <a href="{% url 'home' %}">首页</a>
                    </li>
                    <li class="{% block nav_blog_active %}{% endblock %}">
                        <a href="{% url 'blog:blog_list' %}">博客</a>
                    </li>
                </ul>
                <!-- 导航栏右边 -->
                <ul class="nav navbar-nav navbar-right">
                    {% if not user.is_authenticated %}
                    <li>
                        <a href="{% url 'accounts:login' %}?from={{ request.get_full_path }}">登录</a </li> <li>
                        <a href="{% url 'accounts:register' %}?from={{ request.get_full_path }}">注册</a>
                    </li>
                    {% else %}
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                            {{user.username }} <span class="caret"></span></<a>
                            <ul class="dropdown-menu">
                                <li><a href="{% url 'accounts:user_info' %}">个人中心</a></li>
                                <li><a href="{% url 'accounts:logout' %}?from={{ request.get_full_path }}">退出</a></li>
                            </ul>
                    </li>
                    {% endif %}

                </ul>
            </div>

        </div>
    </div>
    {% block content %}{% endblock content %}

    <!-- Modal 登录弹框-->
    <div class="modal fade" id="login_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <form id="login_modal_form" action="" method="POST">

                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">登录</h4>
                    </div>
                    <div class="modal-body">
                        {% csrf_token %}
                        {{ login_modal_form }}
                        <span class="text-danger" id="login_modal_tip"></span>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">登录</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    </div>
                </form>

            </div>
        </div>
    </div>
    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="{% static 'jquery-1.12.4.min.js' %}"></script>
    <!-- 登录弹框相关js -->
    <script type="text/javascript">
        $('#login_modal_form').submit(function () {
            $.ajax({
                url: "{% url 'accounts:login_for_modal' %}",
                type: 'POST',
                data: $(this).serialize(),
                cache: false,
                success: function (data) {
                    if (data['status'] == 'SUCCESS') {
                        window.location.reload();
                    } else {
                        $('#login_modal_tip').text('用户名或密码错误')
                    }
                },
            });
            return false;
        });
    </script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="{% static 'bootstrap-3.3.7/js/bootstrap.min.js' %}"></script>
    {% block script_extends %}{% endblock script_extends %}
</body>

</html>
```

4. 扩展用户模型
使用这种方式，方便改动数据库结构，如果用继承abstractuser的方式，改动数据库结构需要重新生成数据库。
> [Extending the existing User model](https://docs.djangoproject.com/en/2.2/topics/auth/customizing/)
```python
# accounts/models.py
# 设计用户

from django.db import models
from django.contrib.auth.models import User

class Profile(models.Model):
    """关联自带的用户模型

    """
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    nickname = models.CharField(max_length=20, verbose_name='昵称')

    def __str__(self):
        return f'<Profile:{self.nickname} for {self.user}>'



# accounts/admin.py
# 后台注册

from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
from django.contrib.auth.models import User

from .models import Profile

# 参考官方文档
class ProfileInline(admin.StackedInline):
    model = Profile
    can_delete = False
    verbose_name_plural = '用户'

# Define a new User admin
class UserAdmin(BaseUserAdmin):
    inlines = (ProfileInline,)
    list_display = ('username', 'email', 'nickname', 'is_staff', 'is_active', 'is_superuser')

    # 显示用户nickname
    def nickname(self, obj):
        return obj.profile.nickname

    # 后台管理页面显示中文
    nickname.short_description = '昵称'

# Re-register UserAdmin
admin.site.unregister(User)
admin.site.register(User, UserAdmin)
```
5. 注册、登录完善
```python
# accounts/templates/login.html
# accounts/templates/register.html
# 如果用户已登录，访问注册、登录链接跳转到首页

# templates/base.html
# 如果是管理员，导航栏添加后台登录页面
```

6. 添加昵称，并可修改昵称
```python
# templates/form.html
# 新建通用表单模板

{% extends "base.html" %}
{% block title %}{{ page_title }}{% endblock title %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-xs-4 col-xs-offset-4">
            {% if user.is_authenticated %}
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">{{ form_title }}</h3>
                </div>
                <div class="panel-body">
                    <form action="" method="POST">
                        {% csrf_token %}
                        {% for field in form %}
                        {% if not field.is_hidden %}
                        <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                        {% endif %}
                        {{ field }}
                        <p class="text-danger">{{ field.errors.as_text }}</p>
                        {% endfor %}
                        <span class="pull-left text-danger">{{ form.non_field_errors }}</span>
                        <div class="pull-right">
                            <button class="btn btn-deafult"
                            onclick="window.location.href='{{ return_back_url }}'">返回</button>
                            <input type="submit" value="{{ submit_text }}" class="btn btn-primary pull-right">
                        </div>

                    </form>
                </div>
            </div>
            {# 如果未登录，跳转到登录页面 #}
            {% else %}
            <span>尚未登录，请先登录</span>
            <script type="text/javascript">
                window.location.href = "{% url 'accounts:login' %}";
            </script>
            {% endif %}
        </div>
    </div>
</div>
{% endblock content %}




# accounts/models.py
# 动态绑定方法，方便前端页面获取昵称

from django.db import models
from django.contrib.auth.models import User

class Profile(models.Model):
    """关联自带的用户模型

    """
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    nickname = models.CharField(max_length=20, verbose_name='昵称')

    def __str__(self):
        return f'<Profile:{self.nickname} for {self.user}>'

def get_nickname(self):
    """获取昵称

    :param self:
    :return: 昵称或者空字符串
    """
    if Profile.objects.filter(user=self).exists():
        profile = Profile.objects.get(user=self)
        return profile.nickname
    else:
        return ''

def get_nickname_or_username(self):
    """获取昵称或者用户名

    :param self:
    :return: 昵称或者用户名
    """
    if Profile.objects.filter(user=self).exists():
        profile = Profile.objects.get(user=self)
        return profile.nickname
    else:
        return self.username


def has_nickname(self):
    """判断是否有昵称

    :param self:
    :return: True or False
    """
    return Profile.objects.filter(user=self).exists()

# 动态绑定
User.get_nickname = get_nickname
User.get_nickname_or_username = get_nickname_or_username
User.has_nickname = has_nickname


# accounts/views.py
# 添加修改昵称视图

def change_nickname(request):

    if request.method == 'POST':
        form = ChangeNicknameForm(request.POST, user=request.user)
        if form.is_valid():
            nickname_new = form.cleaned_data['nickname_new']
            profile,created = Profile.objects.get_or_create(user=request.user)
            profile.nickname = nickname_new
            profile.save()

            return redirect(request.GET.get('from', reverse('home')))
    else:
        context = {
            'page_title': '修改昵称',
            'form_title': '修改昵称',
            'submit_text': '修改',
            'return_back_url': request.GET.get('from', reverse('home')),
            'form': ChangeNicknameForm(),
        }

        return render(request, 'form.html', context=context)


# 显示用户名的页面，修改显示昵称


```